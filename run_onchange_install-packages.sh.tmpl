#!/bin/bash

# --- macOS (Homebrew) ---
{{ if eq .chezmoi.os "darwin" -}}
echo "ðŸŽ Detectado macOS. Verificando Homebrew..."

if ! command -v brew &> /dev/null; then
    echo "Instalando Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    if [[ -f /opt/homebrew/bin/brew ]]; then eval "$(/opt/homebrew/bin/brew shellenv)"; fi
    if [[ -f /usr/local/bin/brew ]]; then eval "$(/usr/local/bin/brew shellenv)"; fi
fi

# Lista de paquetes (Modifica esto para forzar re-ejecuciÃ³n si cambias algo)
# Paquetes: {{ list "neovim" "starship" "bat" "eza" "zoxide" "ripgrep" | join " " }}

brew bundle --no-lock --file=/dev/stdin <<EOF
tap "homebrew/cask-fonts"
brew "neovim"
brew "starship"
brew "bat"
brew "eza"
brew "zoxide"
brew "ripgrep"
brew "git"
cask "ghostty"
cask "font-jetbrains-mono-nerd-font"
EOF

# --- Linux (Debian/Ubuntu) ---
{{ else if eq .chezmoi.os "linux" -}}
echo "ðŸ§ Detectado Linux. Instalando dependencias..."

sudo apt update
sudo apt install -y zsh neovim git build-essential curl wget gpg

# Instalar Starship
if ! command -v starship &> /dev/null; then
    curl -sS https://starship.rs/install.sh | sh -s -- -y
fi

# Instalar Zoxide
if ! command -v zoxide &> /dev/null; then
    curl -sS https://raw.githubusercontent.com/ajeetdsouza/zoxide/main/install.sh | bash
fi

# Instalar Bat
sudo apt install -y bat
mkdir -p ~/.local/bin
ln -sf /usr/bin/batcat ~/.local/bin/bat

# Instalar EZA (Reemplazo de LSD) - MÃ©todo oficial repositorio gierens
if ! command -v eza &> /dev/null; then
    echo "Instalando Eza..."
    sudo mkdir -p /etc/apt/keyrings
    wget -qO- https://raw.githubusercontent.com/eza-community/eza/main/deb.asc | sudo gpg --dearmor -o /etc/apt/keyrings/gierens.gpg
    echo "deb [signed-by=/etc/apt/keyrings/gierens.gpg] http://deb.gierens.de stable main" | sudo tee /etc/apt/sources.list.d/gierens.list
    sudo chmod 644 /etc/apt/keyrings/gierens.gpg /etc/apt/sources.list.d/gierens.list
    sudo apt update
    sudo apt install -y eza
fi

{{ end -}}

# --- EjecuciÃ³n comÃºn ---
if ! command -v opencode &> /dev/null; then
    echo "ðŸ¤– Instalando Opencode Agent CLI..."
    curl -fsSL https://opencode.ai/install | bash
fi

if [ "$SHELL" != "$(which zsh)" ]; then
    echo "Cambiando shell a Zsh..."
    chsh -s "$(which zsh)"
fi

echo "âœ… InstalaciÃ³n completada."
